{%import "commonExecuteCallback.js" as commons%}
<!--<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBfYX6GG1foO1l7TAPk2LQVV_nACb7T4Q" type="text/javascript"></script>-->
<script id="flightScript{{prefix}}">
  window.Pixiedust = window.Pixiedust || {};
  window.Pixiedust.flightpredict = window.Pixiedust.flightpredict || {};

  (function(pix) {
    function slideToggleArea(trigger, target) {
      $(trigger).click(function() {
        var that = $(this);
        if (that.hasClass('expanded')) {
          that.find(target).slideUp(500, function() {
            that.removeClass('expanded');
          });
        }
        else {
          that.addClass('expanded');
          that.find(target).slideDown(500);
        }
      });
    }

    pix.flightpredict = {
      resetForm: function() {
        $('#flightpredictform')[0].reset();
        $('#flight-predict-date-one').datepicker('setDate', '2016-10-26');
        $('#flight-predict-date-two').datepicker('setDate', '2016-10-26');

        $('#flight-predict-select-one').empty();
        $('#flight-predict-select-two').empty();

        $('#prediction-models .prediction-models-list').empty();
        $('#weather-forecasts .weather-forecast-list').empty();
        $('.flight-info .chart-notes').empty();

        google.maps.event.clearInstanceListeners(window);
        google.maps.event.clearInstanceListeners(document);
        $('#flightpredict-map').empty();
        this.themap = null;
      },

      predictionTemplate: '<li>' +
        '<div><span>{title}</span></div>' +
        '<div class="prediction-model">{models}</div>' +
        '</li>',

      weatherTemplate: '<li>' +
        '<div><span>{title}</span></div>' +
        '<div class="row weather-forecast">' +
        '<div class="col-sm-6">{departureweather}</div>' +
        '<div class="col-sm-6">{arrivalweather}</div>' +
        '</div></li>',

      airportMarkerTemplate: '<div class="airport-marker-info">' +
        '<h3>{name}</h3>' +
        '<div>{street1}</div>' +
        '<div>{city}, {stateCode} {postalCode}</div>' +
        '<div>Latitude: {latitude}</div>' +
        '<div>Longitude: {longitude}</div>' +
        '</div>',

      flightMarkerTemplate: '<div class="flight-path-info">' +
        '<h3>{carrierFsCode} {flightNumber}</h3>' +
        '<div>{departureAirportFsCode} &gt; {arrivalAirportFsCode}</div>' +
        '</div>',

      themap: null,
      theinfowindow: null,

      renderMap: function() {
        if (this.themap === null) {
            this.themap = new google.maps.Map(document.getElementById('flightpredict-map'), {
              zoom: 4,
              center: new google.maps.LatLng(40, -100),
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              mapTypeControl: false,
              streetViewControl: false,
              rotateControl: false,
              fullscreenControl: false
            });
        }
      },

      renderFlightMap: function(info) {
        this.renderMap();

        var departureInfo = info.departureAirportInfo.airportInfo;
        var arrivalInfo = info.arrivalAirportInfo.airportInfo;
        var flightInfo = info.flightInfo;

        var depAirport = new google.maps.LatLng(departureInfo.latitude, departureInfo.longitude);
        var arrAirport = new google.maps.LatLng(arrivalInfo.latitude, arrivalInfo.longitude);
        var depAirportMarker = new google.maps.Marker({position: depAirport, map: this.themap});
        var arrAirportMarker = new google.maps.Marker({position: arrAirport, map: this.themap});

        var flightPlanCoordinates = [depAirport,arrAirport];
        var flightPath = new google.maps.Polyline({
          path: flightPlanCoordinates,
          strokeColor: '#0000FF',
          strokeOpacity: 0.75,
          strokeWeight: 4
        });
        
        flightPath.setMap(this.themap);

        var depAirportInfoContent = this.airportMarkerTemplate.replace(/\{(.+?)\}/g, function($0, $1) {
          return departureInfo.hasOwnProperty($1) ? departureInfo[$1] : $0;
        });
        var arrAirportInfoContent = this.airportMarkerTemplate.replace(/\{(.+?)\}/g, function($0, $1) {
          return arrivalInfo.hasOwnProperty($1) ? arrivalInfo[$1] : $0;
        });
        var flightPathInfoContent = this.flightMarkerTemplate.replace(/\{(.+?)\}/g, function($0, $1) {
          return flightInfo.hasOwnProperty($1) ? flightInfo[$1] : $0;
        });

        
        if (this.theinfowindow === null) {
          this.theinfowindow = new google.maps.InfoWindow({});
        }
        var infoWindow = this.theinfowindow;

        depAirportMarker.addListener('click', function() {
          infoWindow.setContent(depAirportInfoContent);
          infoWindow.open(this.themap, depAirportMarker);
        });

        arrAirportMarker.addListener('click', function() {
          infoWindow.setContent(arrAirportInfoContent);
          infoWindow.open(this.themap, arrAirportMarker);
        });

        flightPath.addListener('click', function(event) {
          infoWindow.setContent(flightPathInfoContent);
          infoWindow.setPosition(event.latLng);
          infoWindow.open(this.themap);
        });

        google.maps.event.trigger(this.themap,'resize');
      },

      renderPredictionModels: function(info) {
        var predictionInfo = info.prediction;
        var departureAirport = info.flightInfo.departureAirportFsCode;
        var arrivalAirport = info.flightInfo.arrivalAirportFsCode;

        var predictionModel = {
          title: departureAirport + ' > ' + arrivalAirport,
          overall: predictionInfo.overall,
          models: ''
        };

        for (var m in predictionInfo.models) {
          var model = predictionInfo.models[m];
          predictionModel.models += '<div><span>' + model.model + '</span><span>' + model.prediction + '</span></div>';
        }

        var t = $(this.predictionTemplate.replace(/\{(.+?)\}/g, function($0, $1) {
          return predictionModel.hasOwnProperty($1) ? predictionModel[$1] : $0;
        }));

        slideToggleArea(t, '.prediction-model');

        $('#prediction-models .prediction-models-list').append(t);
      },

      renderWeatherForecast: function(info) {
        var departureWeather = info.departureAirportInfo.weatherForecast;
        var arrivalWeather = info.arrivalAirportInfo.weatherForecast;
        var departureAirport = info.flightInfo.departureAirportFsCode;
        var arrivalAirport = info.flightInfo.arrivalAirportFsCode;
        var departureCity = info.departureAirportInfo.airportInfo.city;
        var arrivalCity = info.arrivalAirportInfo.airportInfo.city;

        var weatherForecast = {
          title: departureAirport + ' > ' + arrivalAirport,
          departureweather: '<div>' + departureCity + '</div>' +
            '<div>' + departureWeather.phrase_22char + '</div>' +
            '<div>' + departureWeather.temp + '</div>' +
            '<div>' + departureWeather.wdir_cardinal + '</div>',
          arrivalweather: '<div>' + arrivalCity + '</div>' +
            '<div>' + arrivalWeather.phrase_22char + '</div>' +
            '<div>' + arrivalWeather.temp + '</div>' +
            '<div>' + arrivalWeather.wdir_cardinal + '</div>'
        };

        var t = $(this.weatherTemplate.replace(/\{(.+?)\}/g, function($0, $1) {
          return weatherForecast.hasOwnProperty($1) ? weatherForecast[$1] : $0;
        }));

        slideToggleArea(t, '.weather-forecast');

        $('#weather-forecasts .weather-forecast-list').append(t);
      },

      populateFlightOptions: function(flights, selectNode) {
        for (var f in flights) {
          var flight = flights[f];

          var datetime = new Date(flight.time);
          var hours = datetime.getHours();
          var minutes = datetime.getMinutes();
          var ampm = hours >= 12 ? 'pm' : 'am';
          hours = (hours % 12) || 12;
          minutes = minutes < 10 ? '0' + minutes : minutes;
          var time = hours + ':' + minutes + ampm;

          selectNode.append('<option value="' + flight.flightnumber + ':' + flight.destAirportCode + ':' + datetime.getTime() + '">' + time + ' - ' + flight.destAirportCode + ' (' + flight.flightnumber + ')' + '</option>');
          selectNode.change();
        }
      }
    };
  })(window.Pixiedust);
</script>