{%extends "basedialog.html"%}
{%import "commonExecuteCallback.js" as commons%}
{%block title %}Predict Flight Delays with Apache Spark MLlib, FlightStats, and IBM Insights for Weather{%endblock%}

{%block body%}
  <style>
    .chart-wrapper {
      background: #fff;
      margin: 10px;
      padding: 10px;
    }
    .chart-wrapper .chart-title {
      border-bottom: 1px solid #152935;
      color: #152935;
      font-size: 1.25em;
      font-weight: 400;
      padding: 10px 0px 5px;
    }
    .chart-wrapper .chart-title .memo {
      color: #a6266e;
      float: right;
      font-size: 13px;
      line-height: 26px;
    }
    .chart-wrapper.flight-info .search {
      color: #a6266e;
      cursor: pointer;
      font-weight: 400;
    }
    .chart-wrapper.flight-info .search:hover {
      text-decoration: underline;
    }
    .chart-wrapper .chart-stage {
      overflow: hidden;
      position: relative;
      margin: 10px 0px 5px;
    }
    .chart-wrapper .chart-stage .form-title {
      margin: 10px 0;
    }
    .chart-wrapper .chart-notes {
      color: #a6266e;
      font-size: initial;
    }
    .pixiedust-spinner {
      color: #fff;
      font-size: 24px;
      margin-top: 2px;
    }
    .pixiedust .modal-header {
      background-color: #152935;
      color: #ffffff;
    }
    .pixiedust .modal-body {
      padding: 10px;
    }
    .pixiedust .modal-dialog .btn.focus,
    .pixiedust .modal-dialog .btn:focus {
      outline: none;
    }
    .pixiedust .modal-dialog .btn-cancel,
    .pixiedust .modal-dialog .btn-ok {
      display: none;
    }
    .pixiedust .modal-dialog .btn-back {
      background-color: #fff;
      border: 2px solid #082632;
      color: #082632;
      font-weight: 500;
      float: left;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-back:hover {
      background-color: #082632;
      border-color: #082632;
      color: #fff;
    }
    .pixiedust .modal-dialog .btn-next,
    .pixiedust .modal-dialog .btn-ok {
      background-color: #00b4a0;
      border: 2px solid #00b4a0;
      color: #fff;
      font-weight: 500;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-next:hover,
    .pixiedust .modal-dialog .btn-ok:hover {
      background-color: #fff;
      border: 2px solid #00b4a0;
      color: #00b4a0;
    }
    .pixiedust .modal-dialog .btn-restart {
      background-color: #a6266e;
      border: 2px solid #a6266e;
      color: #fff;
      font-weight: 500;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-restart:hover {
      background-color: #fff;
      border: 2px solid #a6266e;
      color: #a6266e;
    }
    .pixiedust .modal-dialog .btn-search {
      background-color: #fff;
      border: 1px solid #a6266e;
      color: #a6266e;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-search:hover {
      background-color: #a6266e;
      border-color: #a6266e;
      color: #fff;
      font-weight: 500;
    }
    .pixiedust .modal-footer {
      border-top: 0px;
      padding: 20px 30px;
    }
    .pixiedust .modal-dialog svg text {
      fill: black;
      font-size: 11px;
      font-weight: normal;
    }
    .modal-dialog-flightpredictform {
      width: 95% !important;
    }
    .modal-dialog-flightpredictdata {
      width: 95% !important;
    }
    .modal-dialog-flightpredictform .btn-restart {
      display: none;
    }
    .modal-dialog-flightpredictdata .btn-next {
      display: none;
    }
    .modal-header .note {
      color: lightgray;
      display: inline-block;
      float: right;
      font-size: 12px;
      padding: 4px 10px;
    }
    .pixiedust-formfield {
      padding: 10px;
    }
    .pixiedust-formfield .required {
      color: #a6266e;
    }
    .pixiedust-formfield label {
      font-size: 18px;
    }
    .pixiedust-formfield input,
    .pixiedust-formfield select {
      border: 1px solid #1d3649;
      font-size: 20px;
      font-weight: 300;
      margin: 0 0 20px;
      padding: 5px 10px;
    }
    .pixiedust-formfield input:focus,
    .pixiedust-formfield input.focus,
    .pixiedust-formfield select:focus,
    .pixiedust-formfield select.focus {
      border-color: #a6266e;
    }
    .pixiedust-formfield-search {
      display: none;
    }
    .search-flight .pixiedust-formfield-search {
      display: block;
    }
    .search-flight .pixiedust-formfield-default {
      display: none;
    }
  </style>
  <div class="tab-content container-fluid" >
    <div class="tab-pane tab-pane-flightpredictdata row">
      <div class="col-sm-4">
        <div class="chart-wrapper" id="prediction-models">
          <div class="chart-title">
            <span>Prediction Models</span>
            <span class="memo"></span>
          </div>
          <div class="chart-stage">
            <ul class="prediction-models-list"></ul>
          </div>
          <div class="chart-notes">&nbsp;</div>
        </div>
        <div class="chart-wrapper" id="weather-forecasts">
          <div class="chart-title">
            <span>Weather Forecast</span>
            <span class="memo"></span>
          </div>
          <div class="chart-stage">
            <ul class="weather-forecast-list"></ul>
          </div>
          <div class="chart-notes">&nbsp;</div>
        </div>
      </div>
      <div class="col-sm-8">
        <div class="chart-wrapper">
          <div class="chart-title">
            <span>Map</span>
            <span class="memo"></span>
          </div>
          <div class="chart-stage">
            <div id="flightpredict-map" style="height: calc(70vh - 60px);"></div>
          </div>
          <div class="chart-notes">&nbsp;</div>
        </div>
      </div>
    </div>
    <div class="tab-pane tab-pane-flightpredictform row active">
      <div class="col-sm-2"> </div>
      <div class="col-sm-8">
        <div class="chart-wrapper flight-info">
          <div class="chart-title">
            <span>Enter your flight information </span>
          </div>
          <div class="chart-stage">
            <div class="row" style="height: calc(70vh - 60px);">
              <form id="flightpredictform">
              <div class="col-sm-5 flight-one">
                <div class="form-title pixiedust-formfield-default">
                  <span>Enter the date and flight number of the first leg of your trip or </span>
                  <span class="search">search for the flight.</span>
                </div>
                <div class="form-title pixiedust-formfield-search">
                  <span>Enter the date and the approximate time of the first leg of your trip or </span>
                  <span class="search">enter the flight number.</span>
                </div>
                <div class="pixiedust-formfield">
                  <label for="flight-predict-date-one">Flight Date</label>
                  <input id="flight-predict-date-one" name="flight-predict-date-one" class="col-sm-12" type="date" placeholder="e.g., YYYY-MM-DD">
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-default">
                  <label for="flight-predict-flight-one">Flight Number</label>
                  <input id="flight-predict-flight-one" name="flight-predict-flight-one" class="col-sm-12" type="text" placeholder="e.g., VA 0315">
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search">
                  <label for="flight-predict-time-one">Approximate Flight Time</label>
                  <select id="flight-predict-time-one" name="flight-predict-time-one" class="col-sm-12" type="text">
                    <option value="0000">12:00am - 1:00am</option>
                    <option value="0100">1:00am - 2:00am</option>
                    <option value="0200">2:00am - 3:00am</option>
                    <option value="0300">3:00am - 4:00am</option>
                    <option value="0400">4:00am - 5:00am</option>
                    <option value="0500">5:00am - 6:00am</option>
                    <option value="0600">6:00am - 7:00am</option>
                    <option value="0700">7:00am - 8:00am</option>
                    <option value="0800">8:00am - 9:00am</option>
                    <option value="0900">9:00am - 10:00am</option>
                    <option value="1000">10:00am - 11:00am</option>
                    <option value="1100">11:00am - 12:00pm</option>
                    <option value="1200">12:00pm - 1:00pm</option>
                    <option value="1300">1:00pm - 2:00pm</option>
                    <option value="1400">2:00pm - 3:00pm</option>
                    <option value="1500">3:00pm - 4:00pm</option>
                    <option value="1600">4:00pm - 5:00pm</option>
                    <option value="1700">5:00pm - 6:00pm</option>
                    <option value="1800">6:00pm - 7:00pm</option>
                    <option value="1900">7:00pm - 8:00pm</option>
                    <option value="2000">8:00pm - 9:00pm</option>
                    <option value="2100">9:00pm - 10:00pm</option>
                    <option value="2200">10:00pm - 11:00pm</option>
                    <option value="2300">11:00pm - 12:00am</option>
                  </select>
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search" style="text-align: right;">
                  <button class="btn btn-sm btn-search" data-flight-suffix="one">Search Flights</button>
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search">
                  <label for="flight-predict-select-one">Flight</label>
                  <select id="flight-predict-select-one" name="flight-predict-select-one" class="col-sm-12" type="text"></select>
                </div>
              </div>
              <div class="col-sm-2"> </div>
              <div class="col-sm-5 flight-two">
                <div class="form-title pixiedust-formfield-default">
                  <span>If applicable, enter the date and flight number of the first leg of your trip or </span>
                  <span class="search">search for the flight.</span>
                </div>
                <div class="form-title pixiedust-formfield-search">
                  <span>Enter the date and the approximate time of the first leg of your trip </span>
                  <span class="search">enter the flight number.</span>
                </div>
                <div class="pixiedust-formfield">
                  <label for="flight-predict-date-two">Flight Date</label>
                  <input id="flight-predict-date-two" name="flight-predict-date-two" class="col-sm-12" type="date" placeholder="e.g., YYYY-MM-DD">
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-default">
                  <label for="flight-predict-flight-two">Flight Number</label>
                  <input id="flight-predict-flight-two" name="flight-predict-flight-two" class="col-sm-12" type="text" placeholder="e.g., CV 0315">
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search">
                  <label for="flight-predict-time-two">Approximate Flight Time</label>
                  <select id="flight-predict-time-two" name="flight-predict-time-two" class="col-sm-12" type="text">
                    <option value="0000">12:00am - 1:00am</option>
                    <option value="0100">1:00am - 2:00am</option>
                    <option value="0200">2:00am - 3:00am</option>
                    <option value="0300">3:00am - 4:00am</option>
                    <option value="0400">4:00am - 5:00am</option>
                    <option value="0500">5:00am - 6:00am</option>
                    <option value="0600">6:00am - 7:00am</option>
                    <option value="0700">7:00am - 8:00am</option>
                    <option value="0800">8:00am - 9:00am</option>
                    <option value="0900">9:00am - 10:00am</option>
                    <option value="1000">10:00am - 11:00am</option>
                    <option value="1100">11:00am - 12:00pm</option>
                    <option value="1200">12:00pm - 1:00pm</option>
                    <option value="1300">1:00pm - 2:00pm</option>
                    <option value="1400">2:00pm - 3:00pm</option>
                    <option value="1500">3:00pm - 4:00pm</option>
                    <option value="1600">4:00pm - 5:00pm</option>
                    <option value="1700">5:00pm - 6:00pm</option>
                    <option value="1800">6:00pm - 7:00pm</option>
                    <option value="1900">7:00pm - 8:00pm</option>
                    <option value="2000">8:00pm - 9:00pm</option>
                    <option value="2100">9:00pm - 10:00pm</option>
                    <option value="2200">10:00pm - 11:00pm</option>
                    <option value="2300">11:00pm - 12:00am</option>
                  </select>
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search" style="text-align: right;">
                  <button class="btn btn-sm btn-search" data-flight-suffix="two">Search Flights</button>
                </div>
                <div class="pixiedust-formfield pixiedust-formfield-search">
                  <label for="flight-predict-select-two">Flight</label>
                  <select id="flight-predict-select-two" name="flight-predict-select-two" class="col-sm-12" type="text"></select>
                </div>
              </div>
              </form>
            </div>
          </div>
          <div class="chart-notes">&nbsp;</div>
        </div>
      </div>
      <div class="col-sm-2"> </div>
    </div>
  </div>
{%endblock%}

{%block onCancel%}
  $('#results{{prefix}}').html('<p class="text-center">Flight Predict has been cancelled.</p>');
  $('#loading{{prefix}}').css('display','none');
{%endblock%}

{%block onOK%}
  $('#results{{prefix}}').html('<p class="text-center">Thank you for using Flight Predict. Have a safe flight!</p>');
  $('#loading{{prefix}}').css('display','none');
{%endblock%}

{%block onDialogShown%}
  window.Pixiedust = window.Pixiedust || {};
  window.Pixiedust.flightpredict = window.Pixiedust.flightpredict || {};
  var flightpredict = window.Pixiedust.flightpredict;

  var tdiag = $(this).find('.modal-dialog')
    .addClass('modal-dialog-flightpredictform');

  var pixiedustSpinner = $('.pixiedust .modal-header button.close')
    .html('<i class="fa fa-spinner fa-spin pixiedust-spinner"></i>')
    .prop('disabled', true)
    .css({display: 'none'});

  var restartBtn = $('.btn-restart', tdiag);
  var okBtn = $('.btn-ok', tdiag);
  var cancelBtn = $('.btn-cancel', tdiag);
  var searchBtn = $('.btn-search', tdiag);

  var restartBtn = $('<button class="btn btn-sm btn-restart">StartOver</button>');
  var backBtn = $('<button class="btn btn-sm btn-back">Go to Notebook</button>');
  var nextBtn = $('<button class="btn btn-sm btn-next">Continue</button>');

  okBtn.before(backBtn);
  okBtn.after(nextBtn);
  okBtn.after(restartBtn);

  searchBtn.click(function(event) {
    event.preventDefault();
    event.stopPropagation();

    var suffix = $(this).attr('data-flight-suffix');
    var flightDate = $('#flight-predict-date-'+suffix, tdiag).val();
    var flightTime = $('#flight-predict-time-'+suffix, tdiag).val();

    window.Pixiedust.execute_command = "from pixiedust_flightpredict.running.runModel import *" +
      "\nprint(runFlightSearch('" + flightDate + "', '" + flightTime + "'))";

    //search for flights
    {% call(results) commons.ipython_execute("pixiedust_command", prefix) %}
      console.log({{results["error"] or results}});
      {%if results["error"]%}
        alert({{results}});
      {%else%}
        $('.flight-info .chart-notes').empty();
        var jsonResults = JSON.parse({{results}});
        var flights = jsonResults.flights || [];
        flightpredict.populateFlightOptions(flights, $('#flight-predict-select-'+suffix, tdiag))
      {%endif%}
    {% endcall %}
  });

  backBtn.click(function(event) {
    event.preventDefault();
    cancelBtn.click();
  });

  restartBtn.click(function(event) {
    event.preventDefault();

    $('.tab-pane.active').removeClass('active');
    $('.tab-pane-flightpredictform').addClass('active');
    tdiag
      .removeClass('modal-dialog-flightpredictdata')
      .addClass('modal-dialog-flightpredictform');

    flightpredict.resetForm();
  });

  nextBtn.click(function(event) {
    event.preventDefault();

    var flightDate = $('#flight-predict-date-one', tdiag).val();
    var flightNum = null;
    var flightTime = null;
    var errorMessage = null;

    if (!flightDate) {
      errorMessage = 'Missing flight date';
    }
    else {
      if ($('.flight-one').hasClass('search-flight')) {
        flightTime = $('#flight-predict-time-one', tdiag).val();
        if (!flightTime) {
          errorMessage = 'Missing flight time';
        }
        else {
          flightNum = $('#flight-predict-select-one', tdiag).val();
          if (!flightNum) {
             errorMessage = 'Missing flight number';
          }
        }
      }
      else {
        flightNum = $('#flight-predict-flight-one', tdiag).val();
        if (!flightNum) {
          errorMessage = 'Missing flight number';
        }
      }
    }

    if (errorMessage) {
      $('.flight-info .chart-notes').text(errorMessage);
    }
    else {
      window.Pixiedust.execute_command = "from pixiedust_flightpredict.running.runModel import *" +
        "\nprint(runModelTest('" + flightNum + "', '" + flightDate + "'))";

      //Check the flights validatity
      {% call(results) commons.ipython_execute("pixiedust_command", prefix) %}
        console.log({{results["error"] or results}});
        {%if results["error"]%}
          alert({{results}});
        {%else%}
          var jsonResults = JSON.parse({{results}});
          var flightInfo = null;

          if (jsonResults.flightInfo && jsonResults.flightInfo) {
            flightInfo = jsonResults.flightInfo;
          }

          if (flightInfo) {
            $('.tab-pane.active').removeClass('active');
            $('.tab-pane-flightpredictdata').addClass('active');
            tdiag
              .removeClass('modal-dialog-flightpredictform')
              .addClass('modal-dialog-flightpredictdata');

            flightpredict.renderWeatherForecast(jsonResults);
            flightpredict.renderPredictionModels(jsonResults);
            flightpredict.renderFlightInfoMap(jsonResults);
          }
        {%endif%}
      {% endcall %};
    }
  });

  $('.chart-wrapper.flight-info .search').click(function() {
    $(this).parent().parent().toggleClass('search-flight');
  });

  $('#flight-predict-date-one').datepicker({
    dateFormat: 'yy-mm-dd',
    constrainInput: true,
    minDate: new Date(),
    maxDate: '+1m',
    defaultDate: '+1d',
    gotoCurrent: true
  });

  $('#flight-predict-date-two').datepicker({
    dateFormat: 'yy-mm-dd',
    constrainInput: true,
    minDate: new Date(),
    maxDate: '+1m',
    defaultDate: '+1d',
    gotoCurrent: true
  });

  flightpredict.resetForm();

  pixiedustSpinner.after('<a class="note" target="_blank" href="https://github.com/ibm-cds-labs/simple-data-pipe-connector-flightstats">Fork me on GitHub</a>');
{%endblock%}

{%block onDialogHide%}
  
{%endblock%}

{%block cellOuputHTML%}
  <div id="loading{{prefix}}" style="display:none">
    <div style="width:100px;height:60px;left:47%;position:relative">
        <i class="fa fa-circle-o-notch fa-spin" style="font-size:48px"></i>
    </div>
    <div style="text-align:center">Generating the notebook cells for the demo. Please wait...</div>
  </div>
  <div id="results{{prefix}}"></div>
{%endblock%}
